<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Teio Server - æˆ˜ç»©å¤§å… (Rating 2.1 & Impact)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --main-green: #4CAF50; --main-red: #ff5252; --main-white: #ffffff; --dark-bg: #121212; --card-bg: #1e1e1e; --hltv-blue: #4a90e2; --hltv-red: #ff5252; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark-bg); color: white; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; }
        .match-card { background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 40px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* å…ƒæ•°æ® */
        .match-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: #888; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .demo-btn { background: #333; color: #fff; text-decoration: none; padding: 3px 10px; border-radius: 4px; border: 1px solid #444; font-size: 0.9em; transition: 0.2s; margin-right: 15px; }
        .demo-btn:hover { background: var(--main-green); border-color: var(--main-green); }

        /* æ¯”åˆ† */
        .score-display { display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 2em; font-weight: 800; margin-bottom: 25px; }
        .team-score-name { font-size: 0.45em; width: 220px; text-align: center; word-break: break-all; }
        .score-val { color: var(--main-green); background: #000; padding: 5px 20px; border-radius: 5px; min-width: 80px; text-align: center; }

        /* å¸ƒå±€ */
        .teams-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .teams-container { grid-template-columns: 1fr; } }

        .team-section { background: #252525; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .team-title { padding: 12px; font-weight: bold; background: #333; font-size: 0.9em; border-bottom: 2px solid #444; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #2a2a2a; color: #666; font-size: 0.7em; padding: 10px; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #333; font-size: 0.9em; }
        
        .name-cell { text-align: left; padding-left: 15px; font-weight: bold; }
        .multi-kill-cell { color: #aaa; font-size: 0.85em; }

        /* Rating & Impact é…è‰² */
        .rtg-high { color: var(--main-green); font-weight: bold; }
        .rtg-low { color: var(--main-red); font-weight: bold; }
        .rtg-mid { color: var(--main-white); }
        .impact-val { color: #ffa726; font-weight: bold; } /* Impact ä½¿ç”¨æ©™è‰²æ ‡æ³¨ */

        .btn-back { display: inline-block; margin-bottom: 20px; color: #888; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn-back">â† è¿”å›ä¸»é¡µ</a>
        <h1 style="text-align: center; margin-bottom: 30px;">ğŸ† Teio Server æˆ˜ç»©ä¸­å¿ƒ</h1>
        <div id="display-area">åŒæ­¥æˆ˜ç»©æ•°æ®ä¸­...</div>
    </div>

<script>
    // ç»¼åˆ Rating 2.1 ä¸ Impact è®¡ç®—
    function getPlayerStats(p) {
        const rounds = 24; 
        const KPR = p.kills / rounds;
        const DPR = p.deaths / rounds;
        const ADR = p.damage / rounds;
        const APR = p.assists / rounds;

        // è®¡ç®— Impact (å½±å“åŠ›è¯„åˆ†)
        // é€»è¾‘ï¼šå¤šæ€ã€é¦–æ€ã€æ®‹å±€
        let impact = 2.13 * KPR + 0.42 * APR - 0.41;
        impact += (p.entry_wins / rounds) * 0.8;
        impact += (p.enemy3ks * 0.05 + p.enemy4ks * 0.12 + p.enemy5ks * 0.25) / rounds;

        // è®¡ç®— Rating 2.1
        const killRating = KPR / 0.679;
        const survivalRating = (rounds - p.deaths) / rounds / 0.317;
        const damageRating = ADR / 80;
        let rating21 = 0.175 * killRating + 0.175 * survivalRating + 0.25 * damageRating + 0.40 * (impact / 1.1);

        return {
            rating: parseFloat((rating21 * 1.05).toFixed(2)),
            impact: parseFloat(impact.toFixed(2)),
            multis: `${p.enemy3ks}/${p.enemy4ks}/${p.enemy5ks}` // 3k/4k/5k å­—ç¬¦ä¸²
        };
    }

    async function init() {
        const area = document.getElementById('display-area');
        try {
            const res = await fetch('data/matches.json');
            const matches = await res.json();
            area.innerHTML = '';

            for (const m of matches) {
                const csvRes = await fetch(`data/${m.file}`);
                if (!csvRes.ok) continue;

                const csvText = await csvRes.text();
                const players = Papa.parse(csvText, { header: true, dynamicTyping: true }).data.filter(p => p.name);
                
                const teams = {};
                players.forEach(p => {
                    const t = p.team || "æœªçŸ¥";
                    if (!teams[t]) teams[t] = [];
                    const stats = getPlayerStats(p);
                    p.rtg = stats.rating;
                    p.impact = stats.impact;
                    p.multis = stats.multis;
                    teams[t].push(p);
                });

                const tNames = Object.keys(teams);
                let teamsHtml = '';
                tNames.forEach((tn, idx) => {
                    teams[tn].sort((a,b) => b.rtg - a.rtg);
                    let rows = '';
                    teams[tn].forEach(p => {
                        let rtgClass = "rtg-mid";
                        if (p.rtg > 1.05) rtgClass = "rtg-high";
                        else if (p.rtg < 0.95) rtgClass = "rtg-low";

                        rows += `<tr>
                            <td class="name-cell">${p.name}</td>
                            <td style="color:#888;">${p.kills}-${p.deaths}</td>
                            <td>${(p.damage/24).toFixed(1)}</td>
                            <td class="impact-val">${p.impact}</td>
                            <td class="multi-kill-cell">${p.multis}</td>
                            <td class="${rtgClass}">${p.rtg}</td>
                        </tr>`;
                    });
                    teamsHtml += `
                        <div class="team-section">
                            <div class="team-title" style="border-bottom: 2px solid ${idx==0 ? 'var(--hltv-blue)' : 'var(--hltv-red)'}">${tn}</div>
                            <table>
                                <tr>
                                    <th style="text-align:left; padding-left:15px;">é€‰æ‰‹</th>
                                    <th>K-D</th>
                                    <th>ADR</th>
                                    <th>Impact</th>
                                    <th>3k/4k/5k</th>
                                    <th>Rating</th>
                                </tr>
                                ${rows}
                            </table>
                        </div>`;
                });

                area.innerHTML += `
                    <div class="match-card">
                        <div class="match-meta">
                            <div>ğŸ ç»“æŸæ—¶é—´: ${m.end_time || "æœªè®°å½•"}</div>
                            <div>
                                ${m.demo_file ? `<a href="data/${m.demo_file}" class="demo-btn" download>â¬ ä¸‹è½½ Demo</a>` : ''}
                                <span>ID: #${m.id}</span>
                            </div>
                        </div>
                        <div class="score-display">
                            <div class="team-score-name">${tNames[0] || ""}</div>
                            <div class="score-val">${m.score || "VS"}</div>
                            <div class="team-score-name">${tNames[1] || ""}</div>
                        </div>
                        <div class="teams-container">${teamsHtml}</div>
                    </div>`;
            }
        } catch (e) { area.innerHTML = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ã€‚"; }
    }
    init();
</script>
</body>
</html>