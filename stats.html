<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Teio Server - æˆ˜ç»©å¤§å…</title>
    <style>
        :root { --main-green: #4CAF50; --main-red: #ff5252; --dark-bg: #121212; --card-bg: #1e1e1e; --hltv-blue: #4a90e2; --hltv-orange: #ffa726; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark-bg); color: white; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1100px; margin: auto; }
        
        /* éšè—ç±» */
        .hidden { display: none !important; }

        /* æˆ˜ç»©åˆ—è¡¨å¡ç‰‡ */
        .match-list-card { background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .match-list-card:hover { border-color: var(--main-green); transform: translateY(-2px); }
        .match-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #888; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* æ¯”åˆ†å¤§å± */
        .score-display { display: flex; align-items: center; justify-content: center; gap: 30px; font-size: 2.5em; font-weight: 900; }
        .team-name { font-size: 0.4em; width: 220px; text-align: center; color: #ccc; }
        .team-name.winner { color: #fff; font-weight: bold; }
        .score-val { background: #000; padding: 5px 25px; border-radius: 5px; color: var(--main-green); }

        /* è¯¦æƒ…é¡µç‰¹ä¾› */
        .btn-back { display: inline-block; margin-bottom: 25px; background: #333; color: #fff; padding: 8px 20px; border-radius: 5px; cursor: pointer; border: none; font-size: 1em; }
        .btn-back:hover { background: var(--main-green); }

        /* é˜Ÿä¼è¡¨æ ¼å¸ƒå±€ */
        .teams-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        @media (max-width: 950px) { .teams-container { grid-template-columns: 1fr; } }
        .team-section { background: #252525; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .team-title { padding: 12px; font-weight: bold; background: #333; font-size: 0.9em; border-bottom: 2px solid #444; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #2a2a2a; color: #666; font-size: 0.7em; padding: 10px; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 12px 6px; text-align: center; border-bottom: 1px solid #333; font-size: 0.9em; }
        
        .name-cell { text-align: left; padding-left: 15px; font-weight: bold; }
        .impact-val { color: var(--hltv-orange); font-weight: bold; }
        .rtg-high { color: var(--main-green); font-weight: bold; }
        .rtg-low { color: var(--main-red); font-weight: bold; }
        .rtg-mid { color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 30px;">ğŸ† èµ›äº‹æ•°æ®ä¸­å¿ƒ</h1>
        
        <div id="index-view">æ­£åœ¨è¯»å–æœåŠ¡å™¨æ•°æ®...</div>

        <div id="detail-view" class="hidden">
            <button class="btn-back" onclick="showIndex()">â† è¿”å›æ¯”èµ›åˆ—è¡¨</button>
            <div id="detail-content"></div>
        </div>
    </div>

<script>
    let globalMatches = []; // ç¼“å­˜æ¯”èµ›æ•°æ®

    // çœŸæ­£çš„ HLTV Rating 2.1 ç®—æ³• (åŸºäºç¡®åˆ‡çš„åŠ æ—¶èµ›å›åˆä¸é«˜çº§æˆ˜ç»©) 
    function calcProRating(p, totalRounds) {
        const rounds = totalRounds || 24; 
        const KPR = p.k / rounds;
        const DPR = p.d / rounds;
        const ADR = p.dmg / rounds;
        const APR = p.a / rounds;

        let impact = 2.13 * KPR + 0.42 * APR - 0.41;
        impact += (p.entry / rounds) * 0.9;         // é¦–æ€å·¨å¤§åŠ æˆ 
        impact += (p.clutch / rounds) * 0.5;        // æ®‹å±€åŠ æˆ 
        impact += (p.k3 * 0.05 + p.k4 * 0.12 + p.k5 * 0.25) / rounds;

        const killRating = KPR / 0.679;
        const survivalRating = (rounds - p.d) / rounds / 0.317;
        const damageRating = ADR / 80;
        
        let rating21 = 0.175 * killRating + 0.175 * survivalRating + 0.25 * damageRating + 0.40 * (impact / 1.1);
        
        return {
            rating: parseFloat((rating21 * 1.05).toFixed(2)),
            impact: parseFloat(impact.toFixed(2))
        };
    }

    async function init() {
        try {
            const res = await fetch('data/matches.json');
            globalMatches = await res.json();
            showIndex();
        } catch (e) { 
            document.getElementById('index-view').innerHTML = "æˆ˜ç»©åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿åå°è„šæœ¬å·²è¿è¡Œã€‚"; 
        }
    }

    // æ¸²æŸ“é¦–é¡µåˆ—è¡¨
    function showIndex() {
        document.getElementById('detail-view').classList.add('hidden');
        const idxView = document.getElementById('index-view');
        idxView.classList.remove('hidden');
        idxView.innerHTML = '';

        globalMatches.forEach(m => {
            const t1Win = m.team1_score > m.team2_score;
            const t2Win = m.team2_score > m.team1_score;

            idxView.innerHTML += `
                <div class="match-list-card" onclick="showDetail(${m.id})">
                    <div class="match-meta">
                        <span>ğŸ“… ç»“æŸæ—¶é—´: ${m.timestamp} &nbsp;|&nbsp; ğŸ—ºï¸ åœ°å›¾: ${m.map.replace('de_', '').toUpperCase()}</span>
                        <span>ID: #${m.id}</span>
                    </div>
                    <div class="score-display">
                        <span class="team-name ${t1Win ? 'winner' : ''}">${m.team1}</span>
                        <span class="score-val">${m.team1_score} : ${m.team2_score}</span>
                        <span class="team-name ${t2Win ? 'winner' : ''}">${m.team2}</span>
                    </div>
                </div>`;
        });
    }

    // æ¸²æŸ“å•åœºè¯¦æƒ…
    function showDetail(matchId) {
        const m = globalMatches.find(x => x.id === matchId);
        if (!m) return;

        document.getElementById('index-view').classList.add('hidden');
        const detailView = document.getElementById('detail-view');
        detailView.classList.remove('hidden');
        
        const content = document.getElementById('detail-content');
        
        // åˆ†é˜Ÿä¸è®¡ç®—
        const teams = { [m.team1]: [], [m.team2]: [] };
        m.players.forEach(p => {
            if (!teams[p.team]) teams[p.team] = [];
            const stats = calcProRating(p, m.total_rounds);
            p.rtg = stats.rating;
            p.impact = stats.impact;
            teams[p.team].push(p);
        });

        let teamsHtml = '';
        Object.keys(teams).forEach((tn, idx) => {
            teams[tn].sort((a,b) => b.rtg - a.rtg); // Rating é«˜çš„æ’å‰é¢
            let rows = '';
            teams[tn].forEach(p => {
                let rtgClass = p.rtg > 1.05 ? "rtg-high" : (p.rtg < 0.95 ? "rtg-low" : "rtg-mid");
                rows += `<tr>
                    <td class="name-cell">${p.name}</td>
                    <td style="color:#888;">${p.k}-${p.d}</td>
                    <td>${(p.dmg / m.total_rounds).toFixed(1)}</td>
                    <td>${p.entry}</td>
                    <td>${p.clutch}</td>
                    <td class="impact-val">${p.impact}</td>
                    <td class="${rtgClass}">${p.rtg}</td>
                </tr>`;
            });
            teamsHtml += `
                <div class="team-section">
                    <div class="team-title" style="border-bottom: 2px solid ${idx==0 ? 'var(--hltv-blue)' : 'var(--hltv-red)'}">${tn}</div>
                    <table>
                        <tr>
                            <th style="text-align:left; padding-left:15px;">é€‰æ‰‹</th>
                            <th>K-D</th>
                            <th>ADR</th>
                            <th>Entry</th>
                            <th>Clutch</th>
                            <th>Impact</th>
                            <th>Rating</th>
                        </tr>
                        ${rows}
                    </table>
                </div>`;
        });

        content.innerHTML = `
            <div class="match-list-card" style="cursor:default; box-shadow:none;">
                <div class="match-meta">
                    <div>ğŸ“… ${m.timestamp} &nbsp;|&nbsp; â™»ï¸ æœ€ç»ˆå›åˆ: ${m.total_rounds} å±€</div>
                    <div>ID: #${m.id}</div>
                </div>
                <div class="score-display" style="margin-bottom: 10px;">
                    <div class="team-name ${m.team1_score > m.team2_score ? 'winner' : ''}">${m.team1}</div>
                    <div class="score-val">${m.team1_score} : ${m.team2_score}</div>
                    <div class="team-name ${m.team2_score > m.team1_score ? 'winner' : ''}">${m.team2}</div>
                </div>
                <div class="teams-container">${teamsHtml}</div>
            </div>`;
    }

    init();
</script>
</body>
</html>