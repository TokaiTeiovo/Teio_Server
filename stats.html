<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Teio Server - æˆ˜ç»©å¤§å…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --main-green: #4CAF50; --main-red: #ff5252; --main-white: #ffffff; --dark-bg: #121212; --card-bg: #1e1e1e; --hltv-blue: #4a90e2; --hltv-red: #ff5252; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark-bg); color: white; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1100px; margin: auto; }
        
        /* æ¯”èµ›å¡ç‰‡ */
        .match-card { background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 40px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* æ—¶é—´ä¸å…ƒæ•°æ® */
        .match-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #888; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .match-time-group span { margin-right: 15px; }

        /* æ¯”åˆ†åŒºåŸŸ */
        .score-display { display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 2em; font-weight: 800; margin-bottom: 25px; }
        .team-score-name { font-size: 0.45em; width: 220px; text-align: center; word-break: break-all; }
        .score-val { color: var(--main-green); background: #000; padding: 5px 20px; border-radius: 5px; min-width: 80px; text-align: center; }

        /* é˜Ÿä¼å¸ƒå±€ */
        .teams-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 950px) { .teams-container { grid-template-columns: 1fr; } }

        .team-section { background: #252525; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .team-title { padding: 12px; font-weight: bold; background: #333; font-size: 0.9em; display: flex; justify-content: space-between; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #2a2a2a; color: #666; font-size: 0.75em; padding: 10px; text-transform: uppercase; }
        td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #333; }
        
        /* Rating é…è‰² */
        .rtg-high { color: var(--main-green); font-weight: bold; }
        .rtg-low { color: var(--main-red); font-weight: bold; }
        .rtg-mid { color: var(--main-white); }

        .btn-back { display: inline-block; margin-bottom: 20px; color: #888; text-decoration: none; transition: 0.2s; }
        .btn-back:hover { color: var(--main-green); }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn-back">â† è¿”å›ä¸»é¡µ</a>
        <h1 style="text-align: center; margin-bottom: 30px;">ğŸ† æ¯”èµ›æ•°æ®ä¸­å¿ƒ</h1>
        <div id="display-area">æ­£åœ¨è¯»å–æˆ˜ç»©æ¸…å•...</div>
    </div>

<script>
    // åŸºäº CSV å­—æ®µè®¡ç®— Rating 1.0
    function getRating(p) {
        const rounds = 24; 
        const kpr = p.kills / rounds;
        const dpr = p.deaths / rounds;
        const adr = p.damage / rounds;
        let score = ( (kpr/0.679) + ((1-dpr)/0.683) + (adr/90) ) / 3;
        const bonus = (p.enemy2ks*0.02 + p.enemy3ks*0.06 + p.enemy4ks*0.12 + p.enemy5ks*0.25) / rounds;
        return parseFloat((score + bonus).toFixed(2));
    }

    function formatDuration(seconds) {
        if (!seconds) return "æœªçŸ¥";
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}åˆ†${s}ç§’`;
    }

    function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${d} ${hh}:${mm}`;
    }

    async function init() {
        const area = document.getElementById('display-area');
        try {
            const res = await fetch('data/matches.json');
            const matches = await res.json();
            area.innerHTML = '';

            for (const m of matches) {
                const csvRes = await fetch(`data/${m.file}`);
                if (!csvRes.ok) continue;

                const csvText = await csvRes.text();
                const players = Papa.parse(csvText, { header: true, dynamicTyping: true }).data.filter(p => p.name);
                
                // æ—¶é—´æ¨ç®—é€»è¾‘ï¼šç»“æŸæ—¶é—´ - æŒç»­æ—¶é•¿ = å¼€å§‹æ—¶é—´
                const durationRaw = players[0]?.live_time || 0; 
                const endTimeSource = m.start_time || m.end_time;
                let displayStart = "æœªè®°å½•", displayEnd = "æœªè®°å½•";

                if (endTimeSource && endTimeSource !== "æœªè®°å½•") {
                    const endDate = new Date(endTimeSource.replace(/-/g, '/'));
                    const startDate = new Date(endDate.getTime() - durationRaw * 1000);
                    displayStart = formatDate(startDate);
                    displayEnd = formatDate(endDate);
                }

                const teams = {};
                players.forEach(p => {
                    const t = p.team || "æœªçŸ¥";
                    if (!teams[t]) teams[t] = [];
                    p.rtg = getRating(p);
                    teams[t].push(p);
                });

                const tNames = Object.keys(teams);
                let teamsHtml = '';
                tNames.forEach((tn, idx) => {
                    teams[tn].sort((a,b) => b.rtg - a.rtg);
                    let rows = '';
                    teams[tn].forEach(p => {
                        let rtgClass = "rtg-mid";
                        if (p.rtg > 1.05) rtgClass = "rtg-high";
                        else if (p.rtg < 0.95) rtgClass = "rtg-low";

                        rows += `<tr>
                            <td style="text-align:left; padding-left:15px; font-weight:bold;">${p.name}</td>
                            <td style="color:#888;">${p.kills}-${p.deaths}</td>
                            <td>${(p.damage/24).toFixed(1)}</td>
                            <td class="${rtgClass}">${p.rtg}</td>
                        </tr>`;
                    });
                    teamsHtml += `
                        <div class="team-section">
                            <div class="team-title" style="border-bottom: 2px solid ${idx==0 ? 'var(--hltv-blue)' : 'var(--hltv-red)'}">
                                <span>${tn}</span>
                                <span style="font-size:0.8em; color:#888;">Avg: ${(teams[tn].reduce((a,b)=>a+parseFloat(b.rtg),0)/teams[tn].length).toFixed(2)}</span>
                            </div>
                            <table><tr><th>é€‰æ‰‹</th><th>K-D</th><th>ADR</th><th>Rating</th></tr>${rows}</table>
                        </div>`;
                });

                area.innerHTML += `
                    <div class="match-card">
                        <div class="match-meta">
                            <div class="match-time-group">
                                <span>ğŸ“… å¼€å§‹: ${displayStart}</span>
                                <span>ğŸ ç»“æŸ: ${displayEnd}</span>
                            </div>
                            <div>â³ æŒç»­: ${formatDuration(durationRaw)} | ID: #${m.id}</div>
                        </div>
                        <div class="score-display">
                            <div class="team-score-name">${tNames[0] || ""}</div>
                            <div class="score-val">${m.score || "VS"}</div>
                            <div class="team-score-name">${tNames[1] || ""}</div>
                        </div>
                        <div class="teams-container">${teamsHtml}</div>
                    </div>`;
            }
        } catch (e) { area.innerHTML = "æˆ˜ç»©åŠ è½½å¤±è´¥ã€‚"; }
    }
    init();
</script>
</body>
</html>