<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Teio Server - æˆ˜ç»©å¤§å…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --main-green: #4CAF50; --main-red: #ff5252; --main-white: #ffffff; --dark-bg: #121212; --card-bg: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark-bg); color: white; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        .match-card { background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 40px; border: 1px solid #333; }
        
        /* æ—¶é—´ä¿¡æ¯æ  */
        .match-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #888; margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .match-time-group span { margin-right: 15px; }

        .score-display { display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 2em; font-weight: 800; margin-bottom: 25px; }
        .team-score-name { font-size: 0.45em; width: 200px; text-align: center; }
        .score-val { color: var(--main-green); background: #000; padding: 5px 20px; border-radius: 5px; }

        .teams-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 950px) { .teams-container { grid-template-columns: 1fr; } }

        .team-section { background: #252525; border-radius: 4px; overflow: hidden; }
        .team-title { padding: 12px; font-weight: bold; background: #333; font-size: 0.9em; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #2a2a2a; color: #666; font-size: 0.75em; padding: 10px; }
        td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #333; }
        
        /* Rating é…è‰²é€»è¾‘ */
        .rtg-high { color: var(--main-green); font-weight: bold; }
        .rtg-low { color: var(--main-red); font-weight: bold; }
        .rtg-mid { color: var(--main-white); }

        .btn-back { display: inline-block; margin-bottom: 20px; color: #888; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn-back">â† è¿”å›ä¸»é¡µ</a>
        <div id="display-area">æ­£åœ¨è§£ææˆ˜ç»©...</div>
    </div>

<script>
    function getRating(p) {
        const rounds = 24; 
        const kpr = p.kills / rounds;
        const dpr = p.deaths / rounds;
        const adr = p.damage / rounds;
        let score = ( (kpr/0.679) + ((1-dpr)/0.683) + (adr/90) ) / 3;
        const bonus = (p.enemy2ks*0.02 + p.enemy3ks*0.06 + p.enemy4ks*0.12 + p.enemy5ks*0.25) / rounds;
        return parseFloat((score + bonus).toFixed(2));
    }

    // ç§’è½¬æ—¶åˆ†ç§’
    function formatDuration(seconds) {
        if (!seconds) return "æœªçŸ¥";
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}åˆ†${s}ç§’`;
    }

    async function init() {
        const area = document.getElementById('display-area');
        try {
            const res = await fetch('data/matches.json');
            const matches = await res.json();
            area.innerHTML = '';

            for (const m of matches) {
                const csvRes = await fetch(`data/${m.file}`);
                if (!csvRes.ok) continue;

                const csvText = await csvRes.text();
                const players = Papa.parse(csvText, { header: true, dynamicTyping: true }).data.filter(p => p.name);
                
                // ä» CSV çš„ç¬¬ä¸€ä¸ªç©å®¶æ•°æ®ä¸­æå–æ€»æ—¶é•¿
                const durationRaw = players[0]?.live_time; 
                const durationText = formatDuration(durationRaw);

                const teams = {};
                players.forEach(p => {
                    const t = p.team || "æœªçŸ¥";
                    if (!teams[t]) teams[t] = [];
                    p.rtg = getRating(p);
                    teams[t].push(p);
                });

                const tNames = Object.keys(teams);
                const teamA = tNames[0] || "Team A";
                const teamB = tNames[1] || "Team B";
                
                let teamsHtml = '';
                tNames.forEach((tn, idx) => {
                    teams[tn].sort((a,b) => b.rtg - a.rtg);
                    let rows = '';
                    teams[tn].forEach(p => {
                        // Rating é…è‰²é€»è¾‘
                        let rtgClass = "rtg-mid";
                        if (p.rtg > 1.05) rtgClass = "rtg-high";
                        else if (p.rtg < 0.95) rtgClass = "rtg-low";

                        rows += `<tr>
                            <td style="text-align:left; padding-left:15px; font-weight:bold;">${p.name}</td>
                            <td style="color:#888;">${p.kills}-${p.deaths}</td>
                            <td>${(p.damage/24).toFixed(1)}</td>
                            <td class="${rtgClass}">${p.rtg}</td>
                        </tr>`;
                    });

                    teamsHtml += `
                        <div class="team-section">
                            <div class="team-title" style="border-bottom: 2px solid ${idx==0 ? 'var(--hltv-blue)' : 'var(--hltv-red)'}">${tn}</div>
                            <table><tr><th>é€‰æ‰‹</th><th>K-D</th><th>ADR</th><th>Rating</th></tr>${rows}</table>
                        </div>`;
                });

                area.innerHTML += `
                    <div class="match-card">
                        <div class="match-meta">
                            <div class="match-time-group">
                                <span>ğŸ“… å¼€å§‹: ${m.start_time || "æœªè®°å½•"}</span>
                                <span>ğŸ ç»“æŸ: ${m.end_time || "æœªè®°å½•"}</span>
                            </div>
                            <div>â³ æŒç»­: ${durationText} | ID: #${m.id}</div>
                        </div>
                        <div class="score-display">
                            <div class="team-score-name">${teamA}</div>
                            <div class="score-val">${m.score || "VS"}</div>
                            <div class="team-score-name">${teamB}</div>
                        </div>
                        <div class="teams-container">${teamsHtml}</div>
                    </div>`;
            }
        } catch (e) { area.innerHTML = "æˆ˜ç»©åŠ è½½å¤±è´¥ã€‚"; }
    }
    init();
</script>
</body>
</html>